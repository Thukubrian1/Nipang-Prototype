<div class="dashboard-container">
  <!-- Sidebar -->
  <app-sidebar 
    [isOpen]="isSidebarOpen" 
    (toggleSidebar)="handleSidebarToggle()">
  </app-sidebar>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Bar -->
    <app-topbar
      [adminName]="adminName"
      [role]="role"
      [userAvatar]="userAvatar"
      (searchQuery)="handleSearch($event)">
    </app-topbar>

    <!-- Messaging Center Content -->
    <div class="messaging-content">
      
      <!-- Tabs Navigation -->
      <div class="tabs-navigation">
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'summary'"
          (click)="switchTab('summary')">
          Notifications Summary
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'sent'"
          (click)="switchTab('sent')">
          Sent Notifications
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'templates'"
          (click)="switchTab('templates')">
          Message Templates
        </button>

        <!-- Search Bar (position varies by tab) -->
        <div class="tab-search" *ngIf="activeTab === 'summary'">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <select class="search-dropdown" [(ngModel)]="summarySearchBy">
            <option value="title">Title</option>
            <option value="status">Status</option>
            <option value="target">Target</option>
          </select>
          <input 
            type="text" 
            placeholder="Search by title, status..." 
            class="search-input"
            [(ngModel)]="summarySearchQuery">
        </div>

        <div class="tab-search" *ngIf="activeTab === 'sent'">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <select class="search-dropdown" [(ngModel)]="sentSearchBy">
            <option value="title">Title</option>
            <option value="status">Status</option>
            <option value="receiver">Receiver</option>
          </select>
          <input 
            type="text" 
            placeholder="Search by title, status..." 
            class="search-input"
            [(ngModel)]="sentSearchQuery">
        </div>

        <div class="tab-search" *ngIf="activeTab === 'templates'">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <select class="search-dropdown" [(ngModel)]="templateSearchBy">
            <option value="name">Template Name</option>
            <option value="type">Type</option>
            <option value="status">Status</option>
          </select>
          <input 
            type="text" 
            placeholder="Search by name, type..." 
            class="search-input"
            [(ngModel)]="templateSearchQuery">
        </div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        
        <!-- Notifications Summary Tab -->
        <div *ngIf="activeTab === 'summary'" class="summary-tab">
          <div class="section-header">
            <div>
              <h2 class="section-title">Push Notifications</h2>
              <p class="section-subtitle">Send targeted notifications to users and providers</p>
            </div>
            <button class="btn-primary" (click)="openSendNotificationModal()">Send Notification</button>
          </div>

          <!-- Stats Cards -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <h3>Sent Today</h3>
                <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-value">{{sentToday}}</div>
              <div class="stat-footer positive">+{{sentTodayChange}}% vs yesterday</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <h3>Open Rate</h3>
                <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-value">{{openRate}}%</div>
              <div class="stat-footer positive">+{{openRateChange}}% vs last week</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <h3>Click Rate</h3>
                <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-value">{{clickRate}}%</div>
              <div class="stat-footer positive">+{{clickRateChange}}% vs last month</div>
            </div>
          </div>

          <!-- Notifications Table -->
          <div class="data-table">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Target</th>
                  <th>Sent</th>
                  <th>Opens</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let notification of notifications">
                  <td>{{notification.title}}</td>
                  <td>{{notification.target}}</td>
                  <td>{{notification.sent | number:'1.0-0'}}</td>
                  <td>{{notification.opens | number:'1.0-0'}}</td>
                  <td>
                    <span class="status-badge" [class.delivered]="notification.status === 'Delivered'" [class.pending]="notification.status === 'Pending'">
                      {{notification.status}}
                    </span>
                  </td>
                  <td class="actions-cell">
                    <button *ngIf="notification.status === 'Pending'" class="btn-text" (click)="openEditNotificationModal(notification)">Edit</button>
                    <button *ngIf="notification.status === 'Pending'" class="btn-text delete" (click)="openDeleteNotificationModal(notification.id)">Delete</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Sent Notifications Tab -->
        <div *ngIf="activeTab === 'sent'" class="sent-tab">
          <div class="data-table">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Sender</th>
                  <th>Receiver</th>
                  <th>Message</th>
                  <th>Attachment</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let sent of sentNotifications">
                  <td>{{sent.title}}</td>
                  <td>{{sent.sender}}</td>
                  <td>{{sent.receiver}}</td>
                  <td class="message-cell">{{sent.message}}</td>
                  <td class="attachment-cell">{{sent.attachment}}</td>
                  <td>
                    <span class="status-badge" [class.delivered]="sent.status === 'Delivered'" [class.pending]="sent.status === 'Pending'">
                      {{sent.status}}
                    </span>
                  </td>
                  <td class="actions-cell">
                    <button class="btn-text" (click)="openEditSentModal(sent)">Edit</button>
                    <button class="btn-text" (click)="openResendModal(sent.id)">Resend</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination">
            <button class="page-btn" (click)="previousPage()" [disabled]="currentPage === 1">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <button class="page-btn" (click)="goToFirstPage()" [disabled]="currentPage === 1">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="11 17 6 12 11 7"></polyline>
                <polyline points="18 17 13 12 18 7"></polyline>
              </svg>
            </button>
            <button 
              *ngFor="let page of visiblePages" 
              class="page-number" 
              [class.active]="page === currentPage"
              (click)="goToPage(page)">
              {{page}}
            </button>
            <button class="page-btn" (click)="goToLastPage()" [disabled]="currentPage === totalPages">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="13 17 18 12 13 7"></polyline>
                <polyline points="6 17 11 12 6 7"></polyline>
              </svg>
            </button>
            <button class="page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
        </div>

        <!-- Message Templates Tab -->
        <div *ngIf="activeTab === 'templates'" class="templates-tab">
          <div class="section-header">
            <div>
              <h2 class="section-title">Message Templates</h2>
              <p class="section-subtitle">Manage your message templates for notifications, emails, and communications</p>
            </div>
            <button class="btn-primary" (click)="openAddTemplateModal()">Add Template</button>
          </div>

          <!-- Stats Cards -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <h3>Total Messages</h3>
                <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-value">{{totalMessages}}</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <h3>Active</h3>
                <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-value">{{activeMessages}}</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <h3>Inactive</h3>
                <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-value">{{inactiveMessages}}</div>
            </div>
          </div>

          <!-- Templates Table -->
          <div class="data-table">
            <table>
              <thead>
                <tr>
                  <th>Template Name</th>
                  <th>Template Type</th>
                  <th>Subject Line</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let template of templates">
                  <td>{{template.name}}</td>
                  <td>{{template.type}}</td>
                  <td class="subject-cell">{{template.subject}}</td>
                  <td>
                    <span class="status-badge" [class.active]="template.status === 'Active'" [class.inactive]="template.status === 'Inactive'">
                      {{template.status}}
                    </span>
                  </td>
                  <td class="actions-cell">
                    <button class="btn-text" (click)="openEditTemplateModal(template)">Edit</button>
                    <button class="btn-text delete" (click)="openDeleteTemplateModal(template.id)">Delete</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- MODALS -->

  <!-- Send/Edit Notification Modal -->
  <div class="modal-overlay" *ngIf="showNotificationModal" (click)="closeNotificationModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">{{notificationModalMode === 'add' ? 'Notification' : 'Notification'}}</h2>
        <button class="modal-close" (click)="closeNotificationModal()">×</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Notification Title</label>
          <input 
            type="text" 
            class="form-input" 
            [(ngModel)]="notificationForm.title"
            placeholder="Enter notification title">
        </div>

        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea 
            class="form-textarea" 
            [(ngModel)]="notificationForm.message"
            placeholder="Enter message"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Target Audience</label>
          <select class="form-select" [(ngModel)]="notificationForm.target">
            <option value="">All Users</option>
            <option value="nairobi">All Users (Nairobi)</option>
            <option value="providers">Service Providers only</option>
            <option value="admins">Admins Only</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Send Time</label>
          <select class="form-select" [(ngModel)]="notificationForm.sendTime">
            <option value="now">Send now</option>
            <option value="later">Schedule for later</option>
          </select>
        </div>

        <div class="form-group" *ngIf="notificationForm.sendTime === 'later'">
          <label class="form-label">Date and time</label>
          <input 
            type="datetime-local" 
            class="form-input" 
            [(ngModel)]="notificationForm.scheduledDate">
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeNotificationModal()">Cancel</button>
        <button class="btn-save" *ngIf="notificationModalMode === 'add'" (click)="saveNotification()">Save</button>
        <button class="btn-update" *ngIf="notificationModalMode === 'edit'" (click)="updateNotification()">Update</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Template Modal -->
  <div class="modal-overlay" *ngIf="showTemplateModal" (click)="closeTemplateModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">{{templateModalMode === 'add' ? 'Add Template' : 'Edit Template'}}</h2>
        <button class="modal-close" (click)="closeTemplateModal()">×</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Template Name</label>
          <input 
            type="text" 
            class="form-input" 
            [(ngModel)]="templateForm.name"
            placeholder="Enter template name">
        </div>

        <div class="form-group">
          <label class="form-label">Template Type</label>
          <select class="form-select" [(ngModel)]="templateForm.type">
            <option value="">Select template type</option>
            <option value="Email/SMS">Email/SMS</option>
            <option value="Email">Email</option>
            <option value="SMS">SMS</option>
            <option value="Push">Push Notification</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Subject Line</label>
          <input 
            type="text" 
            class="form-input" 
            [(ngModel)]="templateForm.subject"
            placeholder="Enter subject line">
        </div>

        <div class="form-group">
          <label class="form-label">Message Content</label>
          <textarea 
            class="form-textarea" 
            [(ngModel)]="templateForm.content"
            placeholder="Enter your message here ..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Attachment</label>
          <div class="file-upload-area" *ngIf="!templateForm.attachment">
            <svg class="file-upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <p class="file-upload-text">Upload attachment template</p>
            <p class="file-upload-subtext">Maximum file size 10MB</p>
          </div>
          
          <div class="file-uploaded" *ngIf="templateForm.attachment">
            <div class="file-icon">PDF</div>
            <div class="file-info">
              <div class="file-name">{{templateForm.attachment}}</div>
            </div>
            <button class="file-remove" (click)="removeAttachment()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="available-variables">
          <p class="variables-title">Available Variables:</p>
          <div class="variables-list">
            <span class="variable-tag">{{user_name}}</span>
            <span class="variable-tag">{{user_email}}</span>
            <span class="variable-tag">{{event_name}}</span>
            <span class="variable-tag">{{date}}</span>
            <span class="variable-tag">{{time}}</span>
            <span class="variable-tag">{{company_name}}</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Status</label>
          <div class="toggle-group">
            <div 
              class="toggle-switch" 
              [class.active]="templateForm.status === 'Active'"
              (click)="toggleTemplateStatus()">
              <div class="toggle-slider"></div>
            </div>
            <span class="toggle-label">{{templateForm.status}}</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeTemplateModal()">Cancel</button>
        <button class="btn-save" *ngIf="templateModalMode === 'add'" (click)="saveTemplate()">Save</button>
        <button class="btn-update" *ngIf="templateModalMode === 'edit'" (click)="updateTemplate()">Update</button>
      </div>
    </div>
  </div>

  <!-- Delete Notification Confirmation Modal -->
  <div class="modal-overlay confirmation-modal" *ngIf="showDeleteNotificationModal" (click)="closeDeleteNotificationModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Delete Notification</h2>
        <button class="modal-close" (click)="closeDeleteNotificationModal()">×</button>
      </div>
      
      <div class="modal-body">
        <p class="confirmation-text">Are you sure you want to delete this Notification?</p>
        <p class="confirmation-warning">On deleting the notification, there is no way of retrieving it.</p>
      </div>

      <div class="modal-footer">
        <button class="btn-no" (click)="closeDeleteNotificationModal()">NO</button>
        <button class="btn-yes" (click)="confirmDeleteNotification()">YES</button>
      </div>
    </div>
  </div>

  <!-- Delete Template Confirmation Modal -->
  <div class="modal-overlay confirmation-modal" *ngIf="showDeleteTemplateModal" (click)="closeDeleteTemplateModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Delete Message Template</h2>
        <button class="modal-close" (click)="closeDeleteTemplateModal()">×</button>
      </div>
      
      <div class="modal-body">
        <p class="confirmation-text">Are you sure you want to Delete this message Template?</p>
      </div>

      <div class="modal-footer">
        <button class="btn-no" (click)="closeDeleteTemplateModal()">NO</button>
        <button class="btn-yes" (click)="confirmDeleteTemplate()">YES</button>
      </div>
    </div>
  </div>

  <!-- Edit Sent Notification Modal -->
  <div class="modal-overlay" *ngIf="showEditSentModal" (click)="closeEditSentModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Edit Notification</h2>
        <button class="modal-close" (click)="closeEditSentModal()">×</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Template Name</label>
          <input 
            type="text" 
            class="form-input" 
            [(ngModel)]="sentForm.templateName"
            readonly>
        </div>

        <div class="form-group">
          <label class="form-label">Template Type</label>
          <select class="form-select" [(ngModel)]="sentForm.templateType">
            <option value="Email/SMS">Email/SMS</option>
            <option value="Email">Email</option>
            <option value="SMS">SMS</option>
            <option value="Push">Push Notification</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Subject Line</label>
          <input 
            type="text" 
            class="form-input" 
            [(ngModel)]="sentForm.subject"
            placeholder="Welcome to {{company_name}}">
        </div>

        <div class="form-group">
          <label class="form-label">Message Content</label>
          <textarea 
            class="form-textarea" 
            [(ngModel)]="sentForm.message"
            placeholder="Dear {{user_name}},

Welcome to our platform! We are excited to have you on board."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Attachment</label>
          <div class="file-uploaded" *ngIf="sentForm.attachment">
            <div class="file-icon">PDF</div>
            <div class="file-info">
              <div class="file-name">{{sentForm.attachment}}</div>
            </div>
            <button class="file-remove" (click)="removeSentAttachment()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="available-variables">
          <p class="variables-title">Available Variables:</p>
          <div class="variables-list">
            <span class="variable-tag">{{user_name}}</span>
            <span class="variable-tag">{{user_email}}</span>
            <span class="variable-tag">{{event_name}}</span>
            <span class="variable-tag">{{date}}</span>
            <span class="variable-tag">{{time}}</span>
            <span class="variable-tag">{{company_name}}</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Status</label>
          <div class="toggle-group">
            <div 
              class="toggle-switch" 
              [class.active]="sentForm.status === 'Active'"
              (click)="toggleSentStatus()">
              <div class="toggle-slider"></div>
            </div>
            <span class="toggle-label">{{sentForm.status}}</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeEditSentModal()">Cancel</button>
        <button class="btn-update" (click)="updateSentNotification()">Update</button>
      </div>
    </div>
  </div>

  <!-- Resend Notification Confirmation Modal -->
  <div class="modal-overlay confirmation-modal" *ngIf="showResendModal" (click)="closeResendModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Resend Notification</h2>
        <button class="modal-close" (click)="closeResendModal()">×</button>
      </div>
      
      <div class="modal-body">
        <p class="confirmation-text">Are you sure you want to Resend this notification?</p>
      </div>

      <div class="modal-footer">
        <button class="btn-no" (click)="closeResendModal()">NO</button>
        <button class="btn-yes" (click)="confirmResend()">YES</button>
      </div>
    </div>
  </div>

</div>